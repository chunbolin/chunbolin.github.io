#  有挑战的事



##  性能优化

​	我一开始进来就是做的数据库性能优化的工作。因为在交换机、路由器上，我们是纯内存的数据库，并且设备对于我们的性能要求很高，所以性能优化是我们一个重要的工作方向。性能优化对我来说是很有挑战但是也是很有趣的一件事，因为性能优化要求我去更加深入地了解计算机底层的原理，做一些细粒度的优化工作；同时还需要去系统地了解整个架构、各模块的方案，从架构、方案去改善性能。

​	比如对于细粒度的优化工作上，对于纯内存场景，影响很大的一个性能开销就是cachemiss。比如我们DB一次读操作端到端约为1500cycles，但是一次cachemiss大概就有200cycles。因此，我们会去尽量避免cachemiss，包括指令cachemiss和数据cachemiss，我做过的一些优化包括：

1. 尽量减少分支预测失败导致指令cachemiss，使用gcc的_builtin_expect提示编译器该if条件在特定路径下是否会成立，帮助编译器调整代码布局；

2. 把性能路径相关的函数和全局变量编译到so同一个section里，可以提升指令cache的命中率；

3. 把相关的数据尽量放到一个cacheline中，以减少cachemiss；结构体尽量字节对齐，避免访问一个成员要两次访问；

4. 锁的优化，锁需要用原子操作实现，我们这边之前实现的原子操作都是带有完全内存屏障的，这固然是最安全的，但是在锁这边可以用更为宽松的内存屏障，一次加锁操作可以优化20cycles左右；

对于架构或者方案上的优化，我们这边做的有：

1. 二级索引上，使用hc索引替换传统的哈希索引；
2. 使用直连读替换传统的c/s通信；

